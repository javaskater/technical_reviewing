# 189
## getting and accessing a postgres container
### Getting and starting a container from a postgres image
```bash
# we look for the postgres image and create/start a postgresql container at the same time
jmena01@M077-1840900:~$ docker run -itd -e POSTGRES_USER=packt -e POSTGRES_PASSWORD=packt -p 5432:5432 --name postgresql postgres
Unable to find image 'postgres:latest' locally # We download the latest postgres (official) image
latest: Pulling from library/postgres
af302e5c37e9: Pull complete 
23db180a1f67: Pull complete 
dc59dd9c8eb3: Pull complete 
aec09e638045: Pull complete 
4dd47a683737: Pull complete 
7cebbe7849b3: Pull complete 
dc4330b02129: Pull complete 
498cc40b9fe9: Pull complete 
6d3411bb4696: Pull complete 
8f14f34d54d3: Pull complete 
88d4f7416643: Pull complete 
e91ad5cfb8d0: Pull complete 
e0c4d5055fb9: Pull complete 
254ee626d709: Pull complete 
Digest: sha256:87ec5e0a167dc7d4831729f9e1d2ee7b8597dcc49ccd9e43cc5f89e808d2adae
Status: Downloaded newer image for postgres:latest
8bdf0e12660a7d9bfcc0c34ba3246c5991db0920c1b71c6e221e4c9804f0898d
jmena01@M077-1840900:~$ docker ps # my container postgresql (from image postgres) has just been started
CONTAINER ID   IMAGE      COMMAND                  CREATED          STATUS          PORTS                                       NAMES
8bdf0e12660a   postgres   "docker-entrypoint.s…"   49 seconds ago   Up 12 seconds   0.0.0.0:5432->5432/tcp, :::5432->5432/tcp   postgresql
```
### Accessing the Postgres server from the Host
* don't forget the *-h localhost* otherwise it tries to access through a socket
```bash
jmena01@M077-1840900:~$ psql -h localhost -U packt 
Password for user packt: # enter packt 
psql (12.14 (Ubuntu 12.14-0ubuntu0.20.04.1), server 17.2 (Debian 17.2-1.pgdg120+1))
WARNING: psql major version 12, server major version 17.
         Some psql features might not work.
Type "help" for help.

packt=# \q

jmena01@M077-1840900:~$ psql -U packt # if I forget the -h localhost it tries to connect through a local socket
psql: error: la connexion au serveur sur le socket « /var/run/postgresql/.s.PGSQL.5432 » a échoué : Aucun fichier ou dossier de ce type
	Le serveur est-il actif localement et accepte-t-il les connexions sur ce socket ?
```
### Entering datas in the Database
* We are using 
  * the [script for creating the database and 2 tables: teams and players](https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/blob/main/chapter5/recipe5-1/start/sql/db-creation.sql)
    * note that after we have created the database we connect to it in order to place the tables inside it
```sql
CREATE DATABASE football
    WITH
    OWNER = packt
    ENCODING = 'UTF8'
    CONNECTION LIMIT = -1
    IS_TEMPLATE = False;

\c football --we connect to that database so that the tables are connected inside it

CREATE TABLE IF NOT EXISTS teams
(
    id integer GENERATED BY DEFAULT AS IDENTITY,
    name character varying(255),
    CONSTRAINT teams_pkey PRIMARY KEY (id)
);
``` 
  * the [script for entering datas into those 2 tables](https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/blob/main/chapter5/recipe5-1/start/sql/insert-data.sql)
    * note the first order in that script
```sql
\c football --we connect to the newly created database, so we are sure the
``` 
* I pass the 2 scripts using my host's postgres client (psql):
```bash
# football database creation
jmena01@M077-1840900:~/CONSULTANT/my_springboot_30_cookbook/Spring-Boot-3.0-Cookbook/chapter5/recipe5-1/start/sql$ psql -h localhost -U packt -f db-creation.sql # football database creation 
Password for user packt: 
CREATE DATABASE
psql (12.14 (Ubuntu 12.14-0ubuntu0.20.04.1), server 17.2 (Debian 17.2-1.pgdg120+1))
WARNING: psql major version 12, server major version 17. # my client is old (postgres 12 On Ubuntu 20.04) and the server:latest at that date (17/01/2025) is postgresql 17
         Some psql features might not work.
You are now connected to database "football" as user "packt".
CREATE TABLE # teams table creation
CREATE TABLE # players table creation
# Adding a lot of datas to teams and players tables
jmena01@M077-1840900:~/CONSULTANT/my_springboot_30_cookbook/Spring-Boot-3.0-Cookbook/chapter5/recipe5-1/start/sql$ psql -h localhost -U packt -f insert-data.sql 
Password for user packt: 
psql (12.14 (Ubuntu 12.14-0ubuntu0.20.04.1), server 17.2 (Debian 17.2-1.pgdg120+1))
WARNING: psql major version 12, server major version 17.
         Some psql features might not work.
You are now connected to database "football" as user "packt".
psql:insert-data.sql:4: ERROR:  relation "albums" does not exist
LIGNE 1 : INSERT INTO albums # small mistake from a previous version of the book onlys teams and players tables have been previously created
                      ^
INSERT 0 1
INSERT 0 23
# ...............................................
INSERT 0 1
INSERT 0 23
```
### Testing the data entered
* Through psql
```bash
jmena01@M077-1840900:~$ psql -h localhost -U packt -d football # we directly connect to the football database
Password for user packt: 
psql (12.14 (Ubuntu 12.14-0ubuntu0.20.04.1), server 17.2 (Debian 17.2-1.pgdg120+1))
WARNING: psql major version 12, server major version 17.
         Some psql features might not work.
Type "help" for help.

football=# select * from teams LIMIT 10;
   id    |    name    
---------+------------
 1884881 | Argentina
 1882891 | Australia
 1882881 | Brazil
 1883718 | Canada
 1882892 | China PR
 1885035 | Colombia
 1884880 | Costa Rica
 1883719 | Denmark
 1883720 | England
 1884761 | France
(10 rows)

football=# select * from players LIMIT 10;
   id   | jersey_number |         name         |  position  | date_of_birth | team_id 
--------+---------------+----------------------+------------+---------------+---------
 357669 |             2 | Adriana SACHS        | Defender   | 1993-12-25    | 1884881
 420326 |            10 | Dalila IPPOLITO      | Midfielder | 2002-03-24    | 1884881
 420324 |             8 | Daiana FALFAN        | Midfielder | 2000-10-14    | 1884881
 357671 |            17 | Camila GOMEZ ARES    | Midfielder | 1994-10-26    | 1884881
 417317 |            11 | Yamila RODRIGUEZ     | Forward    | 1998-01-24    | 1884881
 420334 |             3 | Eliana STABILE       | Defender   | 1993-11-26    | 1884881
 277423 |             5 | Vanesa SANTANA       | Midfielder | 1990-09-03    | 1884881
 420328 |            14 | Miriam MAYORGA       | Defender   | 1989-11-20    | 1884881
 357674 |            15 | Florencia BONSEGUNDO | Midfielder | 1993-07-14    | 1884881
 461591 |             4 | Julieta CRUZ         | Defender   | 1996-06-04    | 1884881
(10 rows)

football=# 
```
* Other way to do it
```bash
jmena01@M077-1840900:~$ psql -h localhost -U packt
Password for user packt: 
psql (12.14 (Ubuntu 12.14-0ubuntu0.20.04.1), server 17.2 (Debian 17.2-1.pgdg120+1))
WARNING: psql major version 12, server major version 17.
         Some psql features might not work.
Type "help" for help.

packt=# select * from players LIMIT 10;
ERROR:  relation "players" does not exist
LIGNE 1 : select * from players LIMIT 10; # players and teams do not exit in the main database
                        ^
packt=# \c football # we connect to the right database
psql (12.14 (Ubuntu 12.14-0ubuntu0.20.04.1), server 17.2 (Debian 17.2-1.pgdg120+1))
WARNING: psql major version 12, server major version 17.
         Some psql features might not work.
You are now connected to database "football" as user "packt".
football=# select * from players LIMIT 10;
   id   | jersey_number |         name         |  position  | date_of_birth | team_id 
--------+---------------+----------------------+------------+---------------+---------
 357669 |             2 | Adriana SACHS        | Defender   | 1993-12-25    | 1884881
 420326 |            10 | Dalila IPPOLITO      | Midfielder | 2002-03-24    | 1884881
 420324 |             8 | Daiana FALFAN        | Midfielder | 2000-10-14    | 1884881
 357671 |            17 | Camila GOMEZ ARES    | Midfielder | 1994-10-26    | 1884881
 417317 |            11 | Yamila RODRIGUEZ     | Forward    | 1998-01-24    | 1884881
 420334 |             3 | Eliana STABILE       | Defender   | 1993-11-26    | 1884881
 277423 |             5 | Vanesa SANTANA       | Midfielder | 1990-09-03    | 1884881
 420328 |            14 | Miriam MAYORGA       | Defender   | 1989-11-20    | 1884881
 357674 |            15 | Florencia BONSEGUNDO | Midfielder | 1993-07-14    | 1884881
 461591 |             4 | Julieta CRUZ         | Defender   | 1996-06-04    | 1884881
(10 rows)

football=# 
```
* Through PGADMIN4
  * Register server
  * localhost
  * Maintenance Database / User / Password: all **packt**
* PGADMIN 4 works partially
  * some commands give a 500 error (My PGADMIN has version 6.14 the current version is 8.14)
    * perhaps version 8.14 would more be adapted to Postgres 17
    * version 6.14 works well with Postgres 12
  * I can use the Query Editor when the focus is on football (schéma by default: *public*) 
  * Right click on Football Database and select **Generate ERD**
    * You will have figure 5.1
# 191
## Create a [new project through Spring IO](https://start.spring.io/)
* Group *com.packt*
* Artifact *footballpg*
* dependencies (use the *Add Depedencies / search Bar*)
  * Spring Web
  * Spring Data JPA
  * PostgreSQL Driver
```bash
jmena01@M077-1840900:~/Téléchargements$ unzip footballpg.zip -d ~/CONSULTANT/my_springboot_30_cookbook/
Archive:  footballpg.zip
   creating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/
  inflating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/.gitignore  
  inflating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/HELP.md  
   creating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/.mvn/
   creating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/.mvn/wrapper/
  inflating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/.mvn/wrapper/maven-wrapper.properties  
  inflating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/.gitattributes  
   creating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/src/
   creating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/src/test/
   creating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/src/test/java/
   creating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/src/test/java/com/
   creating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/src/test/java/com/packt/
   creating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/src/test/java/com/packt/footballpg/
  inflating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/src/test/java/com/packt/footballpg/FootballpgApplicationTests.java  
   creating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/src/main/
   creating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/src/main/resources/
   creating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/src/main/resources/templates/
   creating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/src/main/resources/static/
  inflating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/src/main/resources/application.properties  
   creating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/src/main/java/
   creating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/src/main/java/com/
   creating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/src/main/java/com/packt/
   creating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/src/main/java/com/packt/footballpg/
  inflating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/src/main/java/com/packt/footballpg/FootballpgApplication.java  
  inflating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/mvnw.cmd  
  inflating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/pom.xml  
  inflating: /home/jmena01/CONSULTANT/my_springboot_30_cookbook/footballpg/mvnw
  ```
  ### In the pom.xml there are the 3 dependencies:
  ```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>

<dependency>
    <groupId>org.postgresql</groupId>
    <artifactId>postgresql</artifactId>
    <scope>runtime</scope>
</dependency>
  ```
  * For the runtime keyword see [answer 181 of this StackOverflow Post](https://stackoverflow.com/questions/12272499/maven-what-is-the-runtime-scope-purpose)
## After completing [Service](https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/blob/main/chapter5/recipe5-1/end/footballpg/src/main/java/com/packt/footballpg/service/TeamsService.java) and [controller](https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/blob/main/chapter5/recipe5-1/end/footballpg/src/main/java/com/packt/footballpg/controller/TeamsController.java)
* don't forget to complete the database access by Spring JDBC
* It is in the file [*src/main/resources/application.yml*](https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/blob/main/chapter5/recipe5-1/end/footballpg/src/main/resources/application.yml)

# 192
* Sarting the embedded server *./mvnw  spring-boot:run*
```bash
jmena01@M077-1840900:~/CONSULTANT/my_springboot_30_cookbook/footballpg$ ./mvnw  spring-boot:run
[INFO] Scanning for projects...
[INFO] 
[INFO] ------------------------< com.packt:footballpg >------------------------
[INFO] Building footballpg 0.0.1-SNAPSHOT
[INFO]   from pom.xml
[INFO] --------------------------------[ jar ]---------------------------------
[INFO] 
[INFO] >>> spring-boot:3.4.1:run (default-cli) > test-compile @ footballpg >>
#.........................
2025-01-17T14:45:40.551+01:00  INFO 145440 --- [footballpg] [           main] org.hibernate.orm.connections.pooling    : HHH10001005: Database info:
        Database JDBC URL [Connecting through datasource 'HikariDataSource (HikariPool-1)']
        Database driver: undefined/unknown
        Database version: 17.2
        Autocommit mode: undefined/unknown
        Isolation level: undefined/unknown
        Minimum pool size: undefined/unknown
        Maximum pool size: undefined/unknown
#............................

2025-01-17T14:45:41.414+01:00  INFO 145440 --- [footballpg] [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port 8080 (http) with context path '/'
# ..........................................;
```
## From the client using curl
```bash
jmena01@M077-1840900:~/Téléchargements$ curl http://localhost:8080/teams/count -H "Accept: application/json"
32
# We verify directly on the database itself
jmena01@M077-1840900:~/Téléchargements$ psql -h localhost -U packt -d football -c "select count(*) from teams" 
Password for user packt: 
 count 
-------
    32
(1 row)
```
# 192
* *@GetMapping("/"* does not work (404) use *@GetMapping* instead
## Test of the *ublic List<Team> getTeams()* service function
```bash
jmena01@M077-1840900:~/Téléchargements$ curl http://localhost:8080/teams -H "Accept: application/json"
[{"id":1884881,"name":"Argentina"},{"id":1882891,"name":"Australia"},{"id":1882881,"name":"Brazil"},{"id":1883718,"name":"Canada"},{"id":1882892,"name":"China PR"},{"id":1885035,"name":"Colombia"},{"id":1884880,"name":"Costa Rica"},{"id":1883719,"name":"Denmark"},{"id":1883720,"name":"England"},{"id":1884761,"name":"France"},{"id":1882879,"name":"Germany"},{"id":1885012,"name":"Haiti"},{"id":1883722,"name":"Italy"},{"id":1885011,"name":"Jamaica"},{"id":1883723,"name":"Japan"},{"id":1885010,"name":"Korea Republic"},{"id":1884821,"name":"Morocco"},{"id":1884883,"name":"Netherlands"},{"id":1883725,"name":"New Zealand"},{"id":1882893,"name":"Nigeria"},{"id":1882882,"name":"Norway"},{"id":1889512,"name":"Panama"},{"id":1885027,"name":"Philippines"},{"id":1884822,"name":"Portugal"},{"id":1884884,"name":"Republic of Ireland"},{"id":1885031,"name":"South Africa"},{"id":1884823,"name":"Spain"},{"id":1882883,"name":"Sweden"},{"id":1884203,"name":"Switzerland"},{"id":1882884,"name":"USA"},{"id":1886308,"name":"Vietnam"},{"id":1885017,"name":"Zambia"}]
```
## Test of the single Team
* [following that Blog](https://mkyong.com/spring/spring-jdbctemplate-querying-examples/) I explicily define the rowMapper this time!!!
* I don't want to use *BeanPropertyRowMapper<>(Team.class)* which infers the row mapping !!!!
  * new Code for the *src/main/java/com/packt/footballpg/service/TeamsService.java* Service:
```java
    private class TeamRowMapper implements RowMapper<Team> {

        @Override
        public Team mapRow(ResultSet rs, int rowNum) throws SQLException {
    
            Team team = new Team();
            team.setId(rs.getInt("id"));
            team.setName(rs.getString("name"));
            return team;
    
        }
    }

    public Team getTeam(Integer id){
        return jdbcTemplate.queryForObject("Select * from teams where id=?", new Object[]{id}, new TeamRowMapper());
    }
```
* I test 
```bash
jmena01@M077-1840900:~/Téléchargements$ curl http://localhost:8080/teams/1882883 -H "Accept: application/json"
{"id":1882883,"name":"Sweden"}
```
# Test part that is not in the book 
* but on the [GitHub solution](https://github.com/PacktPublishing/Spring-Boot-3.0-Cookbook/blob/main/chapter5/recipe5-1/end/footballpg/src/test/java/com/packt/footballpg/TeamsServiceTests.java)
```bash
jmena01@M077-1840900:~/CONSULTANT/my_springboot_30_cookbook/footballpg$ ./mvnw  test
```
* I have problem with assertTrue and assertEquals be careful there are static methods, so the imports are static too:
```java
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.junit.jupiter.api.Assertions.assertEquals;
```
## My test class is working
```java
package com.packt.footballpg;

import org.junit.jupiter.api.Test;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.junit.jupiter.api.Assertions.assertEquals;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.beans.factory.annotation.Autowired;

import com.packt.footballpg.service.TeamsService;
import com.packt.footballpg.entities.Team;

@SpringBootTest
public class TeamsServiceTests {
    
    @Autowired
    private TeamsService teamsService;

    @Test
    public void testGetTeamCount(){
        int count = teamsService.getTeamCount();
        assertTrue(count > 0);
    }

    @Test
    public void testGetTeams(){
        int count = teamsService.getTeams().size();
        assertTrue(count > 0);
    }

    @Test
    public void testASpecificTeam(){
        Team maTeam = teamsService.getTeam(1882883);
        assertEquals(maTeam.getName(), "Sweden");
    }
}
```